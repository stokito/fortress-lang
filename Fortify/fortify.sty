%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%    Copyright 2010 Sun Microsystems, Inc.,
%%    4150 Network Circle, Santa Clara, California 95054, U.S.A.
%%    All rights reserved.
%%
%%    U.S. Government Rights - Commercial software.
%%    Government users are subject to the Sun Microsystems, Inc. standard
%%    license agreement and applicable provisions of the FAR and its supplements.
%%
%%    Use is subject to license terms.
%%
%%    This distribution may include materials developed by third parties.
%%
%%    Sun, Sun Microsystems, the Sun logo and Java are trademarks or registered
%%    trademarks of Sun Microsystems, Inc. in the U.S. and other countries.
%%
%%
%% Stuff for the EMACS "fortify" command (M-&) %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{color}
\usepackage{amssymb} %maths
\usepackage{amsmath} %maths
\usepackage{stmaryrd}
\usepackage{graphicx}
\usepackage[utf8]{inputenc} %useful to type directly accentuated characters


\newcommand\twointersectand{\mathbin{\wedge\mskip-8mu\wedge}}
\newcommand\twointersector{\mathbin{\vee\mskip-8mu\vee}}
\newcommand\twointersectxor{\mathbin{\underline{\vee\mskip-8mu\vee}}}



\newlength{\FortressCodeIndent}
\setlength{\FortressCodeIndent}{1em}
\newlength{\FortressParSkip}
\setlength{\FortressParSkip}{\parskip}
\def\Fortress{\list{}{\leftmargin \FortressCodeIndent
                      \itemindent\listparindent
                      \parsep 0pt plus 1pt}\item
                      \begingroup\FortressInnerMacros\tabbing}
\makeatletter
% Need to be slightly different from \endtabbing
\def\endFortress{\unskip\@stopfield\@addfield\ifdim\wd\@curline>0pt\@startfield\@stopline\fi
  \ifnum\@tabpush >\z@ \@badpoptabs \fi\endtrivlist\endgroup\endlist}
\makeatother
\newdimen\FortressMathsurround   \FortressMathsurround=0.166666em
\newcommand\FortressMathsurroundFixup[1]{\ifdim \lastskip = 0pt \hskip-#1\FortressMathsurround \fi}

\newcommand\FortressOuterKWD[1]{{\FortressMathsurroundFixup{1}\ensuremath{\mathtt{#1}\mathsurround=\FortressMathsurround}}}
\newcommand\FortressOuterKWDVAR[1]{{\FortressMathsurroundFixup{1}\ensuremath{\mathtt{#1}\mathsurround=\FortressMathsurround}}}
\newcommand\FortressOuterOPR[1]{{\FortressMathsurroundFixup{1}\ensuremath{\mathtt{#1}\mathsurround=\FortressMathsurround}}}
\newcommand\FortressOuterTYP[1]{{\FortressMathsurroundFixup{0.5}\ensuremath{\mathrm{#1}\mathsurround=0.5\FortressMathsurround}}}
\newcommand\FortressOuterVAR[1]{{\FortressMathsurroundFixup{0.5}\ensuremath{\mathit{#1}\mathsurround=0.5\FortressMathsurround}}}
\newcommand\FortressOuterSTR[1]{{\FortressMathsurroundFixup{1}\ensuremath{\hbox{\tt\usefont{T1}{pcr}{m}{n}\selectfont#1}\mathsurround=\FortressMathsurround}}}
\newcommand\EXP[1]{{\FortressMathsurroundFixup{1}\ensuremath{{\protect\FortressInnerMacros\let\*=\fortresslinecomment#1}\mathsurround=\FortressMathsurround}}}
\newcommand\FortressOuterMacros{\let\KWD\FortressOuterKWD \let\KWDVAR\FortressOuterKWDVAR
  \let\OPR\FortressOuterOPR \let\TYP\FortressOuterTYP \let\VAR\FortressOuterVAR \let\STR\FortressOuterSTR}

\FortressOuterMacros

\newcommand\FortressInnerKWD[1]{\mathrel{\mathtt{#1}}}
\newcommand\FortressInnerKWDVAR[1]{\mathord{\mathtt{#1}}}
\newcommand\FortressInnerOPR[1]{\mathbin{\mathtt{#1}}}
\newcommand\FortressInnerBIGOPR[1]{\mathop{\lower0.4ex\hbox{\vrule height 1.2em depth 0.1em width 0pt\Large$\mathtt{#1}$}}}
\newcommand\FortressInnerBIGOP[1]{\mathop{\lower0.2ex\hbox{\Large$#1$}}}
\newcommand\FortressInnerTYP[1]{\mathord{\mathrm{#1}}}
\newcommand\FortressInnerVAR[1]{\mathord{\mathit{#1}}}
\newcommand\FortressInnerSTR[1]{\hbox{\tt\usefont{T1}{pcr}{m}{n}\selectfont#1}}
\newcommand\FortressInnerMacros{\let\KWD\FortressInnerKWD \let\KWDVAR\FortressInnerKWDVAR
  \let\OPR\FortressInnerOPR \let\BIGOPR\FortressInnerBIGOPR \let\BIGOP\FortressInnerBIGOP
  \let\TYP\FortressInnerTYP \let\VAR\FortressInnerVAR \let\STR\FortressInnerSTR}

\newcommand\CONDEQ{\mathrel{\mathtt{:}}=\mathrel{\mathtt{:}}}
\newcommand\ASSIGN{\mathrel{\mathtt{:}}=}
\newcommand\COLON{\mathpunct{\mathtt{:}}}
\newcommand\COLONOP{\mathinner{\mathtt{:}}}
\newcommand\SHORTCUT[1]{\mathrel{\mathord{#1}\mathord{:}}}
\newcommand\verythin{{\ensuremath{\mskip 1.5mu}}}
\newcommand\ultrathin{{\ensuremath{\mskip 0.75mu}}}
\def\Vvert{\mathrel{\vert\mskip-1.5mu\vert\mskip-1.5mu\vert}}
\def\VVert{\mathrel{\vert\mskip-1.5mu\vert\mskip-1.5mu\vert\mskip-1.5mu\vert}}
\def\sequiv{\mathrel{\hbox{\raise0.215ex\hbox to 0pt{$\equiv$\hss}\lower0.215ex\hbox{$\equiv$}}}}

\newcommand\bigllbracket{\bigl[\mkern-5mu\bigl[}
\newcommand\bigrrbracket{\bigr]\mkern-5mu\bigr]}
\newcommand\Bigllbracket{\Bigl[\mkern-5.5mu\Bigl[}
\newcommand\Bigrrbracket{\Bigr]\mkern-5.5mu\Bigr]}
\newcommand\biggllbracket{\biggl[\mkern-6mu\biggl[}
\newcommand\biggrrbracket{\biggr]\mkern-6mu\biggr]}
\newcommand\Biggllbracket{\Biggl[\mkern-6.5mu\Biggl[}
\newcommand\Biggrrbracket{\Biggr]\mkern-6.5mu\Biggr]}
\newcommand\leftllbracket{\left[\mkern-5.5mu\left[}
\newcommand\rightrrbracket{\right]\mkern-5.5mu\right]}


\newcommand\FortressUnknownCharacter[1]{{\fboxsep=0.166666em\fbox{\small\tt#1}}}

%% The old FortressDoc (introduced in r1437) is not working any more.
%% It is going to be replaced by the new fortify tool soon.
%% We'll not adjust the indentation of the Fortress documentation
%% embedded in the Fortress code for now.
%%
\newenvironment{FortressDoc}[1]{\tt {#1}}{}
% \newenvironment{FortressDoc}[1]{\vspace{0.5ex}%
% \begin{list}{}{%
%   \setlength{\parskip}{\FortressParSkip}
%   \settowidth{\leftmargin}{{\tt {#1}}}%
%   \addtolength{\leftmargin}{\FortressCodeIndent}}%
%      \item[]\raggedright%
% }{\unskip\end{list}\vspace{-3ex}}


\newcommand\FortexSettings{%
\setlength{\FortressCodeIndent}{0em}%
}

\medmuskip=4mu plus 2mu minus 1mu\relax      %Normal LaTeX has 4mu plus 2mu minus 4mu


\newdimen\fortressblanklineskip  \fortressblanklineskip=4pt
\newdimen\fortresscommentparskip  \fortresscommentparskip=4pt
\newdimen\fortresscommentrulethickness  \fortresscommentrulethickness=0.5pt
\newdimen\fortressleftindentincrement
\newdimen\fortressrightindentincrement  \fortressrightindentincrement=1em
\newdimen\fortresscommentruleraise
\newdimen\fortresscommentrulemargin
\newdimen\fortresscommentrulecorner
\newdimen\fortresscommentparensoffset

\newbox\fortresscodeline
\newbox\fortresstempbox
\newbox\fortressresultbox
\newbox\fortresscommentbox
\newbox\fortresstabstack
\newbox\fortresssavedtabstack
\newdimen\fortresstempdimen
\newdimen\fortresscurindent
\newdimen\fortressnewindent
\newif\iffortresstopcommentline
\newif\iffortressbottomcommentline
\newif\iffortresscommentalignblock
\newif\iffortresspng  \fortresspngfalse

\definecolor{almostwhite}{rgb}{0.99,0.99,0.99}

\newcommand\FortressCode{\lineskip=1.5pt\lineskiplimit=1.5pt
  \setbox\fortresssavedtabstack=\box\fortresstabstack
  \global\setbox\fortresstabstack=\hbox{\hbox{}}\relax
  \FortressInnerMacros
  \let\+=\fortresspushtab
  \let\-=\fortresspoptab
  \let\1=\fortresscodeindentone
  \let\2=\fortresscodeindenttwo
  \let\3=\fortresscodeindentthree
  \let\*=\fortresslinecomment
  \def荇糗莒弭苘杰骘螋蝈篌扉铄莒弭苒杰骘螋蝈篌忮玳钽镯礤铘犰殓钼祜汶莒弭茌杰骘螋蝈篌孱溷镯礤铘犰殓钼祜汶茕彐茕殓轸忪犷臌荏弭怙敖荑怙褒荑怙麸荀浒荑篌苕矧趄弩筱镯礤铘犰殓钼祜汶驷祗荇镳箦鸾答痨躞拆莛狎箦鸾莛狎箅轲莛狎麸痼屦奖痿痨躞别荇蜷鲮轶荛翦碹荪澡茼狒栾疱轭翳铄扉铄痱弼孱趔戾徜轭茼狒栩屐ㄡ骘脲黠蜾骝镯轭箦螋轭珈蹂苕矧趄弩筲彗轭扉铄荛骀矧趄弩箴铉茼狒栾疱铥荑怙麸梆酐荑箅轲荑箝遘泔祜螓犰盹篝麒轸妪荟蝓戾桢殓梏爱鞍别鏖漪爱鞍别糗梵簖苕檐殓铒蝈箴徙弩茕彐苠钿骑螋蝈篌蔑溴苕矧趄弩箦钿扉铄苠钿趄轹扉篝茜祜忉燔箦翕秫苕矧趄弩篝徕篝徙虢茆秫苕矧趄弩篌狯邃翎怏翎汶茴鬻泔眄犷滠骘螋蝈篌忮玳铎轭妍苕矧趄弩篁弭蜷弼孱鬻轭溴铘苕矧趄弩筱躜轭溴铘杰骘螋蝈篌铄鏖钿孱荏弭怙苕矧趄弩筱镤屐轭褰荑怙荛骀矧趄弩箴铉荑怙麸梆酐茔镬矧犰盹篝麒轸妪荟蝓戾桢殓梏爱鞍别鏖漪爱鞍别糗梵簖苕荑箅轲苕矧趄弩筱躜轭溴铘荏趄豸苕矧趄弩筲彗轭骈屐潺茴鬻泔眄犷滠骘螋蝈篌孱潇轭妍荃铙腴疖骘螋蝈篌孱滏殄熹荛驿轫荀滠骘螋蝈篌泔溴扉铄苕矧趄弩筱躜轭溴铘茴镩钿孱糗怙苕矧趄弩筱镤屐轭遘疳苠祗荛骀矧趄弩筱镯礤铘犰殓钼祜汶茴镝扉珙荟箅轲苕矧趄弩筲灬铍扉铄箅轲茯屐狲苠祗荟箅轲苕矧趄弩筲灬铍扉铄箅轲苕苕辇茴鬻泔眄犷滠骘螋蝈篌汜钽屐扉铄苕矧趄弩箦钿骈屐潺茴鬻泔眄犷滠骘螋蝈篌忮玳铈殄熹荏弭怙苕矧趄弩筱镤屐轭褰荑怙茆珧秕茆秫苕矧趄弩筱镤屐轭遘ㄜ溟箴灬篝戾荛珙矧弩疳沐簖茴鬻泔眄犷滠骘螋蝈篌孱滏殄熹茴蹯燔┸彗蝻躔茴鬻泔眄犷滠骘螋蝈篌瘐箬翎恹苕矧趄弩箦钿骈屐苕矧趄弩箢鬻轭溴铘杰麂苕矧趄弩筱镤屐轭茜祜忉燔箦翕秫苕矧趄弩篝徕篝徙虢荑怙荃铊怙苕矧趄弩篝徕篝徙荑怙麸苕矧趄弩箢鬻轭溴铘荑篌茯屐狲苕矧趄弩筲彗轭骈屐潺茴鬻泔眄犷滠骘螋蝈篌痫痿徕苕矧趄弩箦钿骈屐茜祜忉燔箦翕秫苕矧趄弩篝徕篝徙虢荑怙荃铊怙苕矧趄弩篝徕篝徙荏弭怙苕矧趄弩篝屙疴秫杰灬篝怙茯屐狲苕矧趄弩篁弭蜷弼孱鬻轭溴铘苕矧趄弩筲彗轭骈屐潺茴鬻泔眄犷滠骘螋蝈篌蝈趄殄鲥铄鏖钿孱酐茯屐狲茜祜忉燔箦翕秫苕矧趄弩篝徕篝徙虢荑怙荃铊怙苕矧趄弩篝徕篝徙茜祜忉燔箦翕秫苕矧趄弩篝屙疴秫杰灬篝怙茯屐狲苕矧趄弩箢鬻轭溴铘杰麂苕矧趄弩篝屙疴秫茜祜忉燔箦翕秫苕矧趄弩篝徕篝徙虢荑怙荃铊怙苕矧趄弩篝徕篝徙茆秫苕矧趄弩篝屙疴秫茴鬻泔眄犷滠骘螋蝈篌泔溴轭溴铘镱妍茼箅轲疙茴鬻泔眄犷滠骘螋蝈篌泔溴轭溴铘赭稃鼙鼙茴鬻泔眄犷滠骘螋蝈篌泔溴轭溴铘翳蝈妍鼙鼙鼙茴鬻泔眄犷滠骘螋蝈篌泔眄孱趔屦荑箅轲碑靛ボ铄縻镯磲钿苕矧趄弩箪轭邈镯礤铘簌礅镬荑怙茯衢箦拆糗桠秫ぼ筱蜷痿筱蜷痿篝戾茔轵沆邃狍簸ボ铄縻镯磲钿苕矧趄弩箪轭邈镯礤铘簌礅镬荑怙茯衢箦爱撤屮荑怙荑怙麸梆酐ぼ筱蜷痿篝戾茱糸礤螭荑怙ぼ筱蜷痿篝戾茱痨躞ボ铄縻镯磲钿苕矧趄弩箪轭邈镯礤铘簌礅镬荑怙荏弭怙敖荑怙ぼ筱蜷痿篝戾茱滹簸茯屐狲荑怙茯衢箦爱插荑怙麸荀浒荑篌ぼ狍簸荑篌茯衢箦爱撤屮荑怙麸梆酐荑篌茆秫褒茴鬻泔眄犷滠骘螋蝈篌扉铄泔眄孱趔礅镬荑怙荏弭怙敖荑怙ぼ筱蜷痿篝戾茱滹簸荑篌茯屐狲荑怙茯衢箦爱胺屮荑怙麸荀浒荑篌荇舄荑篌茯衢箦爱撤屮荑怙麸梆酐荑篌茆秫褒茴鬻泔眄犷滠骘螋蝈篌扉铄泔眄孱糅陛苕矧趄弩箪轭邈镯礤铘簌礅镬荑怙芷矧趄弩笙豸弪歪泸矬茕彐莛孱犰豉卑鞍败茯恚饼茴鬻泔眄犷滠骘螋蝈篌犰殓铄潇轭邈镯礤铘郾蓰苕矧趄弩箦钿骈屐莒遽鲥鲰镤遘怙苕矧趄弩筱镤屐轭濡荏弭怙苕矧趄弩筱镤屐轭褰荑怙苕矧趄弩筲彗轭骈屐苕矧趄弩箪轭邈镯礤铘簌礅镬荑怙芷矧趄弩笙豸弪歪泸矬茕彐莛孱犰豉卑鞍败茯恚饼茴鬻泔眄犷滠骘螋蝈篌镱屐轭邈镯礤铘鄢蓰荑怙荇簦饼芷矧趄弩笙豸弪歪泸矬茕彐莛孱犰豉卑鞍败茯恚阐荇簦除茴鬻泔眄犷滠骘螋蝈篌扉铄苕矧趄弩箦钿扉铄苕矧趄弩筲彗轭扉铄茴鬻泔眄犷滠骘螋蝈篌泔眄孱翎扉珙忪镢腱轭妍苕矧趄弩箦钿骈屐莒遽鲥鲰镤遘怙苕矧趄弩筱镤屐轭遘泸茴鬻泔眄犷滠骘螋蝈篌忮玳钽镯礤铘犰殓钼祜汶苕矧趄弩筱犷沐祆轭遘忮玳铉蝻躔莒弭苘杰骘螋蝈篌泔眄孱翎扉珙忪镢腱轭莒弭塥杰骘螋蝈篌犰殓铄潇轭邈镯礤铘荇徕箅轲桨痿荑犰殓钴忡蝻躔苕矧趄弩筲彗轭扉铄＃荑骈歃＃荑骈燔泸茴鬻泔眄犷滠骘螋蝈篌孱溷镯礤铘犰殓钼祜汶苠珧秕疖孱溏蝻躔苕矧趄弩筲彗轭扉铄茴鬻泔眄犷滠骑螋蝈篌洛玳蠲镯礤铘苕矧趄弩筲祜汶泔眄孱酐茴鬻泔眄犷滠骑螋蝈篌洛玳钇祯箬蔑眄孱酐苕矧趄弩筲祜汶泔眄孱酐莒彐趔腴鸾梆糗蜷玷趔腴鸾梆酏茴鬻泔眄犷滠骑螋蝈篌洛玳钇祯箬体骠蔑眄孱酐苕矧趄弩筲祜汶泔眄孱酐莒彐趔腴鸾梆酏茴鬻泔眄犷滠骑螋蝈篌洛玳钇祯箬议玷裘镯礤铘苕矧趄弩筲祜汶泔眄孱酐茯殓梏箅轲桨痿茴鬻泔眄犷滠骑螋蝈篌葬珑邃洛玳蠲镯礤铘苕矧趄弩筲祜汶泔眄孱酐茴鬻泔眄犷滠骑螋蝈篌葬珑邃洛玳钇祯箬蔑眄孱酐苕矧趄弩筲祜汶泔眄孱酐莒彐趔腴鸾梆糗蜷玷趔腴鸾梆酏茴鬻泔眄犷滠骑螋蝈篌葬珑邃洛玳钇祯箬体骠蔑眄孱酐苕矧趄弩筲祜汶泔眄孱酐莒彐趔腴鸾梆酏茴鬻泔眄犷滠骑螋蝈篌葬珑邃洛玳钇祯箬议玷裘镯礤铘苕矧趄弩筲祜汶泔眄孱酐茯殓梏箅轲桨痿ゥ身痫螋犷轭鲠蜷犷轭忪镢泔眄孱趔麒孱弼弪秕狎轭栾蜷镱翎盹溴秕狎ゥ鏖翳轭茆彗轭珧秕瓞犷蝈趱蝾轭麸鲥螋殂犰盹溴眭篝犰麽孱翳狒珧秕甬茴鬻泔眄犷滠骘螋蝈篌忪镢脬镯礤铘鄄蓰苕矧趄弩筱犷沐祆轭茆彗轭珧秕疖扉铄箅轲奖痿莒轭弩腴痨轫轸奖痿荏弭怙苕矧趄弩筱镯礤铘怙杰鲡秫茆珧秕茚漩犷沐荑箝怡苕矧趄弩筱躜轭溴铘荏弭怙苕矧趄弩篝屙疴秫杰桠秫荇í\leftskip=\wd\fortresstempbox
  \setbox\fortresstempbox=\hbox{\tt *)}\rightskip=\wd\fortresstempbox
  \sloppy
  #1\relax
  \FortressOuterMacros
  \let\item=\fortressitem
  \let\enum=\fortressenum
  \let\desc=\fortressdesc
  \let\lind=\fortressleftindent
  \def莛孱犰豉卑鞍败莒弭苘杰骘螋蝈篌孱溷镯礤铘疳蜥珧狃莒弭苕矧趄弩箐镢镯礤铘蝓戾杰蝈灬茕彐莒彐趄蹯妍茕彐苕矧趄弩箐镢镯礤铘蝓戾苕矧趄弩筱镯礤铘蝓戾苕矧趄弩箴矬轸轱铎彐趄蹯妪茯屐狲茕彐茯殓梏蝓戾茕彐苕矧趄弩箐镢镯礤铘蝓戾苕矧趄弩筱镯礤铘蝓戾苕矧趄弩箴矬轸轱铗殓梏蝓戾茯屐狲茕彐莒彐趄殓梏蝓戾茕彐苕矧趄弩箐镢镯礤铘蝓戾苕矧趄弩筱镯礤铘蝓戾苕矧趄弩箴矬轸轱铎彐趄殓梏蝓戾茯屐狲苕矧趄弩篝镳泔眄孱綮轭彐犰箦苕矧趄弩筲雉麸磴镯礤铘扉铄驷祗茕彐荇镳泔眄孱綮轭妍苕矧趄弩筱镯礤铘扉铄茯殓梏箅轲梆酏梆酏苕矧趄弩篝镳泔眄孱綮轭弭蝓遘疳蜍孱溏蝻躔茯屐狲茕彐茆雉麸磴镯礤铘扉铄荛骅盹溴莛狎苠钿珧秕疖骈茆彗轭珧秕疖戾狯弼盹溴苕矧趄弩筱镯礤铘扉铄莒彐趔腴瘕梆酏梆酏苕矧趄弩筲雉麸磴镯礤铘扉铄趄蹂茯屐狲茕彐荇镳蜷玷翥镯礤铘扉铄苕矧趄弩筱镯礤铘扉铄茯殓梏箅轲梆酏苕矧趄弩筱镯礤铘蝓戾磲蜱轭苕矧趄弩篝镳泔眄孱綮轭弭蝓遘疳蜍孱溏蝻躔茯屐狲茕彐茆雉麸盱彐翥镯礤铘扉铄荛骅盹溴莛狎苠钿珧秕疖骈茆彗轭珧秕疖戾狯弼盹溴苕矧趄弩筱镯礤铘扉铄莒彐趔腴瘕苕矧趄弩筱镯礤铘蝓戾磲蜱轭梆酏苕矧趄弩筲雉麸磴镯礤铘扉铄趄蹂茯屐狲荏弭怙苕矧趄弩篝屙疴秫杰桠秫构ぼ眢腴讽酩茯屐狲苕矧趄弩箪彐糸钿孱糸钽蝈礤铘杰麂苕矧趄弩篝屙疴秫莛狎轭溴铘桨痿莛狎箅轲杰骘螋蝈篌泔眄孱麴狎箅轲荇苕矧趄弩筱镯礤铘蝓戾蜥轶褰爱跺苕矧趄弩筱镯礤铘蝓戾泔蝾弪桨靛苕矧趄弩筱镯礤铘疳蝈铙镦骟弭桨冲荏弭怙苕矧趄弩篝屙疴秫杰桠秫荇\relax
      \fortresscommentrulemargin=0.8\wd\fortresstempbox
  \rm
  \leavevmode\begingroup
  \hbox{\hskip -\leftskip \hskip-\fortresscommentparensoffset{\tt (*#2}\hskip\fortresscommentparensoffset}}

\newcommand\FortressEndCommentLeft{\ifhmode\par\fortressendcommentendgroup\fi\leavevmode
  \hbox{\hskip -\leftskip \hskip-\fortresscommentparensoffset{\tt *)}\hskip\fortresscommentparensoffset}\relax
  \fortressendblockcomment}

\newcommand\FortressEndComment{\ifhmode\fortressendcommentendgroup\else\leavevmode\fi
  \penalty10000\hfill
  \hbox{\hskip\fortresscommentparensoffset
        {\tt *)}\hskip-\fortresscommentparensoffset\hskip -\rightskip}\relax
        \fortressendblockcomment}

\newcommand\FortressTaggedEndCommentLeft[1]{\ifhmode\par\fortressendcommentendgroup\fi\leavevmode
%\newcommand\FortressTaggedEndCommentLeft[1]{\ifhmode\par\endgroup\fi\fortressendcommentendgroup\leavevmode
  \hbox{\hskip -\leftskip \hskip-\fortresscommentparensoffset{\tt #1*)}\hskip\fortresscommentparensoffset}\relax
  \fortressendblockcomment}

\newcommand\FortressTaggedEndComment[1]{\ifhmode\fortressendcommentendgroup\else\leavevmode\fi
  \penalty10000\hfill
  \hbox{\hskip\fortresscommentparensoffset{\tt #1*)}\hskip -\fortresscommentparensoffset
        \hskip -\rightskip}\fortressendblockcomment}

\newcommand\fortressendcommentendgroup{\global\let\fortresstemp=\fortressdocommentrule
  \iffortressbottomcommentline \global\fortresstempdimen=1pt \else \global\fortresstempdimen=0pt \fi
  \endgroup
  \let\fortressdocommentrule=\fortresstemp
  \ifdim \fortresstempdimen > 0pt \fortressbottomcommentlinetrue \else \fortressbottomcommentlinefalse \fi}

\newcommand\fortressendblockcomment{\par
  \fortressdocommentrule\egroup
  \unvbox\fortresscommentbox\endgroup
  \fortressbeginline}
  
\newcommand\fortresscommentline[3]{{\fortresstempdimen=\hsize
  \advance\fortresstempdimen by -#1\relax
  \setbox\fortresstempbox=\hbox{\tt (*}\relax
  \advance\fortresstempdimen by -\wd\fortresstempbox
  \leavevmode
  \raise \fortresscommentruleraise\hbox{\hbox to 0pt{\hss
        \vrule height \fortresscommentrulethickness
               width \ifdim \leftskip=0pt #2 \else\fortresscommentrulemargin\fi}\relax
        \vrule height \fortresscommentrulethickness
               width \fortresstempdimen
        \hbox to 0pt{\relax
          \vrule height \fortresscommentrulethickness
               width\ifdim \rightskip=0pt #3 \else\fortresscommentrulemargin\fi\hss}\relax}}}

\newcommand\fortressrightindent[1]{\advance\rightskip by #1\fortressrightindentincrement}

\newcommand\fortressleftindent[1]{\ifhmode\par\endgroup\fi\begingroup
  \advance\leftskip by #1\fortressleftindentincrement
  \leavevmode\ignorespaces}

\newcommand\fortressitem[2]{\fortressleftindent{#1}%
  \hbox to 0pt{\hss\csname fortressitem\romannumeral#2\endcsname$\mskip 7mu$}\ignorespaces}
  
\newcommand\fortressitemi{\raise 0.2ex\hbox{$\scriptstyle\bullet$}}
\newcommand\fortressitemii{\raise 0.2ex\hbox{$\scriptstyle\circ$}}
\newcommand\fortressitemiii{\raise 0.2ex\hbox{$\scriptscriptstyle\blacktriangleright$}}
\newcommand\fortressitemiv{\raise 0.2ex\hbox{$\scriptstyle\triangleright$}}
\newcommand\fortressitemv{$\star$}
\newcommand\fortressitemvi{$\diamond$}
\newcommand\fortressitemvii{$\sim$}
\newcommand\fortressitemviii{$\cdot$}

\newcommand\fortressenum[3]{\fortressleftindent{#1}%
  \hbox to 0pt{\hss\csname fortressenum\romannumeral#2\endcsname{#3}$\mskip 7mu$}\ignorespaces}

\newcommand\fortressenumi[1]{(\number #1)}
\newcommand\fortressenumii[1]{(\romanletter{#1})}
\newcommand\fortressenumiii[1]{(\romannumeral #1)}
\newcommand\fortressenumiv[1]{(\Romanletter{#1})}
\newcommand\fortressenumv[1]{\number #1.}
\newcommand\fortressenumvi[1]{\Romanletter{#1}.}
\newcommand\fortressenumvii[1]{\romannumeral #1.}
\newcommand\fortressenumviii[1]{\romanletter{#1}.}

\makeatletter
\newcommand\romanletter[1]{\@alph{#1}}   % Makes use of LaTeX internals
\newcommand\Romanletter[1]{\@Alph{#1}}   % Makes use of LaTeX internals
\makeatother

% \FortressDescription{level}{labeltext}{leftindent}
\newcommand\fortressdesc[3]{\ifhmode\par\endgroup\fi\begingroup
  \advance\leftskip by #1\fortressleftindentincrement
  \advance\leftskip by #3\fortressleftindentincrement
  \advance\leftskip by -\fortressleftindentincrement
 \setbox\fortresstempbox=\hbox{\hskip-#3\fortressleftindentincrement
                               \hbox{#2}\relax   % This inner \hbox makes \FortressMathsurroundFixup work properly
                               \quad}\relax
  \leavevmode\copy\fortresstempbox
  \ifdim \wd\fortresstempbox < 0pt \hskip-\wd\fortresstempbox \fi
  \ignorespaces}

\newcommand\fortressendcommentparagraph{\ifhmode\par\endgroup\else\vskip\parskip\fi}

\newskip\fortressskipA
\newskip\fortressskipB
\newskip\fortressskipC
\newskip\fortressskipD
\newskip\fortressskipE
\newskip\fortressskipF
\newcount\fortresspenaltyA
\newcount\fortresspenaltyB
\newcount\fortresspenaltyC
\newcount\fortresspenaltyD
\newcount\fortresspenaltyE
\newcount\fortresspenaltyF
\newbox\fortressboxA
\newbox\fortressboxB
\newif\iffortress

\newcommand\fortresscommentrule[1]{\begingroup
    \fortressskipF=\lastskip \unskip
    \fortresspenaltyF=\lastpenalty \unpenalty
    \fortressskipE=\lastskip \unskip
    \fortresspenaltyE=\lastpenalty \unpenalty
    \fortressskipD=\lastskip \unskip
    \fortresspenaltyD=\lastpenalty \unpenalty
    \setbox\fortressboxB\lastbox
    \setbox\fortressresultbox=\vbox{
      \hbox{#1{\fortressbottomleftrule}{\fortressbottomrightrule}\relax
            \box\fortressboxB}
      \penalty\fortresspenaltyD\fortressrulevskip{#1}{\fortressskipD}
      \penalty\fortresspenaltyE\fortressrulevskip{#1}{\fortressskipE}
      \penalty\fortresspenaltyF\fortressrulevskip{#1}{\fortressskipF}}
    \fortressskipC=\lastskip \unskip
    \fortresspenaltyC=\lastpenalty \unpenalty
    \fortressskipB=\lastskip \unskip
    \fortresspenaltyB=\lastpenalty \unpenalty
    \fortressskipA=\lastskip \unskip
    \fortresspenaltyA=\lastpenalty \unpenalty
    \setbox\fortressboxA\lastbox
    \iffortressbottomcommentline
      \fortressskipC=0pt
      \fortressskipA=0pt
    \fi
  \loop
    \fortressskipF=\fortressskipC
    \fortresspenaltyF=\fortresspenaltyC
    \fortressskipE=\fortressskipB
    \fortresspenaltyE=\fortresspenaltyB
    \fortressskipD=\fortressskipA
    \fortresspenaltyD=\fortresspenaltyA
    \setbox\fortressboxB=\box\fortressboxA
    \fortressskipC=\lastskip \unskip
    \fortresspenaltyC=\lastpenalty \unpenalty
    \fortressskipB=\lastskip \unskip
    \fortresspenaltyB=\lastpenalty \unpenalty
    \fortressskipA=\lastskip \unskip
    \fortresspenaltyA=\lastpenalty \unpenalty
    \setbox\fortressboxA=\lastbox
    \ifvoid\fortressboxA \fortressfalse \else \fortresstrue \fi
  \iffortress
    \setbox\fortressresultbox=\vbox{
      \hbox{#1{\fortressmaincommentrule}{\fortressmaincommentrule}\relax
            \box\fortressboxB}
      \penalty\fortresspenaltyD\fortressrulevskip{#1}{\fortressskipD}
      \penalty\fortresspenaltyE\fortressrulevskip{#1}{\fortressskipE}
      \penalty\fortresspenaltyF\fortressrulevskip{#1}{\fortressskipF}
      \unvbox\fortressresultbox}
  \repeat
  \penalty\fortresspenaltyA\vskip\fortressskipA
  \penalty\fortresspenaltyB\vskip\fortressskipB
  \penalty\fortresspenaltyC\vskip\fortressskipC
  \hbox{#1{\fortresstopleftrule}{\fortresstoprightrule}\relax
        \box\fortressboxB}
  \iffortresstopcommentline\else
    \penalty\fortresspenaltyD\fortressrulevskip{#1}{\fortressskipD}
  \fi
  \penalty\fortresspenaltyE\fortressrulevskip{#1}{\fortressskipE}
  \iffortresstopcommentline\else
    \penalty\fortresspenaltyF\fortressrulevskip{#1}{\fortressskipF}
  \fi
  \unvbox\fortressresultbox
  \endgroup}

\newcommand\fortressmaincommentrule{\vrule width \fortresscommentrulethickness
                                           height \ht\fortressboxB
                                           depth \dp\fortressboxB}
\newcommand\fortresstopleftrule{\begingroup
             \fortresstempdimen=\fortresscommentrulethickness
             \advance\fortresstempdimen by \fortresscommentruleraise
             \vrule width \fortresscommentrulethickness
                    height \fortresstempdimen
                    depth \dp\fortressboxB
             \iffortresstopcommentline
               \raise \fortresscommentruleraise\hbox to 0pt{\relax
                 \vrule width \fortresscommentrulecorner
                        height \fortresscommentrulethickness
                        depth 0pt\hss}\fi
           \endgroup}
\newcommand\fortresstoprightrule{\begingroup
             \fortresstempdimen=\fortresscommentrulethickness
             \advance\fortresstempdimen by \fortresscommentruleraise
             \vrule width \fortresscommentrulethickness
                    height \fortresstempdimen
                    depth \dp\fortressboxB
           \endgroup}
\newcommand\fortressbottomleftrule{\begingroup
                 \fortresstempdimen=\ht\fortressboxB
                 \advance\fortresstempdimen by -\fortresscommentruleraise
                 \raise \fortresscommentruleraise\hbox{\relax
                   \vrule width \fortresscommentrulethickness
                          height \fortresstempdimen
                          depth 0pt}\relax
               \endgroup}
\newcommand\fortressbottomrightrule{\begingroup
                 \fortresstempdimen=\ht\fortressboxB
                 \advance\fortresstempdimen by -\fortresscommentruleraise
                 \raise \fortresscommentruleraise\hbox{\relax
                   \iffortressbottomcommentline
                      \hbox to 0pt{\hss
                         \vrule width \fortresscommentrulecorner
                                height \fortresscommentrulethickness
                                depth 0pt}\fi
                   \vrule width \fortresscommentrulethickness
                          height \fortresstempdimen
                          depth 0pt}\relax
               \endgroup}

\newcommand\fortressrulevskip[2]{\cleaders\vbox{\hbox to 0pt{\relax
  \vrule width 0pt height #2\relax
  \vbox to 0pt{\vss
               #1{\fortressgluerule{#2}}{\fortressgluerule{#2}}\relax
               \vskip -1pt}\hss}}\vskip#2}

\newcommand\fortressgluerule[1]{\begingroup
                    \fortresstempdimen=#1\relax
                    \advance\fortresstempdimen by 1pt
                    \vrule width \fortresscommentrulethickness
                           height \fortresstempdimen
                           depth 1pt
                  \endgroup}

\newcommand\fortresspositionleftrule[2]{\hbox to 0pt{\hskip\leftskip
  \hbox to 0pt{\hss#1\hskip\fortresscommentrulemargin}\hss}}

\newcommand\fortresspositionrightrule[2]{\hbox to 0pt{\hskip\hsize \hskip-\rightskip
  \hskip\fortresscommentrulemargin{#2}\hss}}
 
\newcommand\fortresspositionleftrightrule[2]{\hbox to 0pt{\hskip\leftskip
  \hbox to 0pt{\hss#1\hskip\fortresscommentrulemargin}\hskip-\leftskip
  \hskip\hsize \hskip-\rightskip \hskip\fortresscommentrulemargin{#2}\hss}}

\newcommand\FortressTable[1]{\ifhmode\par\endgroup\fi
  \leavevmode\begingroup
  \advance\leftskip by #1\fortressleftindentincrement
  \begin{tabular}}
\newcommand\FortressEndTable{\end{tabular}\par\endgroup}

\newcommand\FortressParagraphImage[1]{%
  \fortresstempdimen=\hsize
  \advance\fortresstempdimen by -\leftskip
  \advance\fortresstempdimen by -\rightskip
  \edef\fortresstemp{[width=\the\fortresstempdimen]}
  \expandafter\includegraphics\fortresstemp{#1}}

\newcommand\FortressInlineImage[1]{\includegraphics[width=1in]{#1}}
